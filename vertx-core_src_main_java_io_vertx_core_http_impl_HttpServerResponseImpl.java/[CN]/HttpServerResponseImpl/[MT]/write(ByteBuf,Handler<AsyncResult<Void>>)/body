{
  checkWritten();
  if (!headWritten && version != HttpVersion.HTTP_1_0 && !chunked && !contentLengthSet()) {
    throw new IllegalStateException("You must set the Content-Length header to be the total size of the message " + "body BEFORE sending any data if you are not using HTTP chunked encoding.");
  }
  if (!headWritten) {
    prepareHeaders();
    channelFuture=conn.write(new AssembledHttpResponse(response,chunk));
    headWritten=true;
  }
 else {
    channelFuture=conn.write(new DefaultHttpContent(chunk));
  }
  conn.addFuture(completionHandler,channelFuture);
  return this;
}
