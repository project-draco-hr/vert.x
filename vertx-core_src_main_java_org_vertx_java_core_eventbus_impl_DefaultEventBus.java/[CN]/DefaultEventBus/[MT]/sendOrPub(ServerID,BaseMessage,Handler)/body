{
  checkStarted();
  DefaultContext context=vertx.getOrCreateContext();
  try {
    message.sender=serverID;
    if (replyHandler != null) {
      message.replyAddress=prefix + String.valueOf(seq.incrementAndGet());
      registerHandler(message.replyAddress,replyHandler,null,true,true);
    }
    if (replyDest != null) {
      if (!replyDest.equals(this.serverID)) {
        sendRemote(replyDest,message);
      }
 else {
        receiveMessage(message);
      }
    }
 else {
      if (subs != null) {
        subs.get(message.address,new AsyncResultHandler<ServerIDs>(){
          public void handle(          AsyncResult<ServerIDs> event){
            if (event.succeeded()) {
              ServerIDs serverIDs=event.result();
              if (!serverIDs.isEmpty()) {
                sendToSubs(serverIDs,message);
              }
 else {
                receiveMessage(message);
              }
            }
 else {
              log.error("Failed to send message",event.cause());
            }
          }
        }
);
      }
 else {
        receiveMessage(message);
      }
    }
  }
  finally {
    if (context != null) {
      vertx.setContext(context);
    }
  }
}
