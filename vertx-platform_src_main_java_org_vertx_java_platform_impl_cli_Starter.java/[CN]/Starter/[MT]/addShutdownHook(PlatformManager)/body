{
  Runtime.getRuntime().addShutdownHook(new Thread(){
    public void run(){
      final CountDownLatch latch=new CountDownLatch(1);
      mgr.undeployAll(new Handler<AsyncResult<Void>>(){
        public void handle(        AsyncResult<Void> res){
          latch.countDown();
        }
      }
);
      try {
        if (!latch.await(30,TimeUnit.SECONDS)) {
          log.error("Timed out waiting to undeploy");
        }
      }
 catch (      InterruptedException e) {
        throw new IllegalStateException(e);
      }
      mgr.stop();
      Runnable task;
      while ((task=afterShutdownTasks.poll()) != null) {
        try {
          task.run();
        }
 catch (        Throwable t) {
          log.error("Failed to run after shutdown task",t);
        }
      }
    }
  }
);
}
