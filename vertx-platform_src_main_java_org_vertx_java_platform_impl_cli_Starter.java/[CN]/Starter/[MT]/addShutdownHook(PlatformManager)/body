{
  Runtime.getRuntime().addShutdownHook(new Thread(){
    public void run(){
      final CountDownLatch latch=new CountDownLatch(1);
      mgr.undeployAll(new Handler<AsyncResult<Void>>(){
        public void handle(        AsyncResult<Void> res){
          latch.countDown();
        }
      }
);
      try {
        if (!latch.await(30,TimeUnit.SECONDS)) {
          log.error("Timed out waiting to undeploy");
        }
      }
 catch (      InterruptedException e) {
        throw new IllegalStateException(e);
      }
      mgr.stop();
    }
  }
);
}
