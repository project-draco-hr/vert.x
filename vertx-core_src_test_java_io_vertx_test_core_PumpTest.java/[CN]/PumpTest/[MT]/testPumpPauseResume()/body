{
  FakeReadStream rs=new FakeReadStream();
  FakeWriteStream ws=new FakeWriteStream();
  Pump p=Pump.pump(rs,ws,500);
  p.start();
  for (int i=0; i < 10; i++) {
    Buffer inp=Buffer.buffer();
    for (int j=0; j < 4; j++) {
      Buffer b=TestUtils.randomBuffer(100);
      inp.appendBuffer(b);
      rs.addData(b);
      assertFalse(rs.paused);
      assertEquals(i,rs.pauseCount);
      assertEquals(i,rs.resumeCount);
    }
    Buffer b=TestUtils.randomBuffer(100);
    inp.appendBuffer(b);
    rs.addData(b);
    assertTrue(rs.paused);
    assertEquals(i + 1,rs.pauseCount);
    assertEquals(i,rs.resumeCount);
    assertEquals(inp,ws.received);
    ws.clearReceived();
    inp=Buffer.buffer();
    assertFalse(rs.paused);
    assertEquals(i + 1,rs.pauseCount);
    assertEquals(i + 1,rs.resumeCount);
  }
}
