{
  DefaultNetSocket socket=new DefaultNetSocket(vertx,channel,context,server.tcpHelper,false);
  channel.attr(VertxHandler.KEY).set(socket);
  endReadAndFlush();
  ChannelPipeline pipeline=channel.pipeline();
  ChannelHandler compressor=pipeline.get(HttpChunkContentCompressor.class);
  if (compressor != null) {
    pipeline.remove(compressor);
  }
  pipeline.remove("httpDecoder");
  if (pipeline.get("chunkedWriter") != null) {
    pipeline.remove("chunkedWriter");
  }
  channel.pipeline().replace("handler","handler",new VertxNetHandler(server.vertx){
    @Override public void channelRead(    ChannelHandlerContext chctx,    Object msg) throws Exception {
      if (msg instanceof HttpContent) {
        ReferenceCountUtil.release(msg);
        return;
      }
      super.channelRead(chctx,msg);
    }
  }
);
  if (lastWriteFuture == null) {
    channel.pipeline().remove("httpEncoder");
  }
 else {
    lastWriteFuture.addListener(new ChannelFutureListener(){
      @Override public void operationComplete(      ChannelFuture future) throws Exception {
        channel.pipeline().remove("httpEncoder");
      }
    }
);
  }
  return socket;
}
