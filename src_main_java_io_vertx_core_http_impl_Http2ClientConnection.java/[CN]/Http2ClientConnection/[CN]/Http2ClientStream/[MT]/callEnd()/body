{
  if (conn.metrics.isEnabled()) {
    if (request.exceptionOccurred) {
      conn.metrics.requestReset(request.metric());
    }
 else {
      conn.metrics.responseEnd(request.metric(),response);
    }
  }
  responseEnded=true;
  response.handleEnd(null,new CaseInsensitiveHeaders());
}
