{
  if (closed) {
    writeClosed(lst);
    lst.close();
  }
 else   if (this.listener != null) {
    writeClosed(lst,2010,"Another connection still open");
    lst.close();
  }
 else {
    cancelTimer();
    this.listener=lst;
    if (!openWritten) {
      writeOpen(lst);
      sockHandler.handle(this);
      handleCalled=true;
    }
    if (listener != null) {
      if (closed) {
        writeClosed(lst);
        listener=null;
        lst.close();
      }
 else {
        if (!pendingWrites.isEmpty()) {
          writePendingMessages();
        }
      }
    }
  }
}
