{
  upgradedConnection=true;
  DefaultNetSocket socket=new DefaultNetSocket(vertx,channel,context,client.tcpHelper,true);
  channel.attr(VertxHandler.KEY).set(socket);
  endReadAndFlush();
  ChannelPipeline pipeline=channel.pipeline();
  ChannelHandler inflater=pipeline.get(HttpContentDecompressor.class);
  if (inflater != null) {
    pipeline.remove(inflater);
  }
  pipeline.remove("codec");
  pipeline.replace("handler","handler",new VertxNetHandler(client.vertx){
    @Override public void channelRead(    ChannelHandlerContext chctx,    Object msg) throws Exception {
      if (msg instanceof HttpContent) {
        ReferenceCountUtil.release(msg);
        return;
      }
      super.channelRead(chctx,msg);
    }
  }
);
  return socket;
}
