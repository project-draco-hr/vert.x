{
  conn=s;
  s.beginRequest(this);
  if (pendingMaxSize != -1) {
    this.conn.doSetWriteQueueMaxSize(pendingMaxSize);
  }
  if (pendingChunks != null) {
    ByteBuf pending=pendingChunks;
    pendingChunks=null;
    if (completed) {
      writeHeadWithContent(pending,true);
      s.connection().reportBytesWritten(written);
      if (respHandler != null) {
        this.conn.endRequest();
      }
    }
 else {
      writeHeadWithContent(pending,false);
      if (headersCompletionHandler != null) {
        headersCompletionHandler.handle(s.version());
      }
    }
  }
 else {
    if (completed) {
      writeHeadWithContent(Unpooled.EMPTY_BUFFER,true);
      s.connection().reportBytesWritten(written);
      if (respHandler != null) {
        this.conn.endRequest();
      }
    }
 else {
      if (writeHead) {
        writeHead();
        if (headersCompletionHandler != null) {
          headersCompletionHandler.handle(s.version());
        }
      }
    }
  }
}
