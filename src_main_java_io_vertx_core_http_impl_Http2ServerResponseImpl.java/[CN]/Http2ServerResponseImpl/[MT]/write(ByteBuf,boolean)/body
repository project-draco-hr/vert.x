{
  checkEnded();
  int len=chunk.readableBytes();
  boolean empty=len == 0;
  checkSendHeaders(empty && end);
  if (!empty) {
    bytesWritten+=len;
    encoder.writeData(ctx,stream.id(),chunk,0,end && trailers == null,ctx.newPromise());
  }
  if (trailers != null && end) {
    encoder.writeHeaders(ctx,stream.id(),trailers,0,true,ctx.newPromise());
  }
  try {
    encoder.flowController().writePendingBytes();
  }
 catch (  Http2Exception e) {
    e.printStackTrace();
  }
  if (end) {
    ended=true;
  }
  ctx.flush();
  if (end && bodyEndHandler != null) {
    bodyEndHandler.handle(null);
  }
}
