{
  if (address.length() > maxAddressLength) {
    log.error("Refusing to register as address length > max_address_length");
    return;
  }
  final SockInfo info=sockInfos.get(sock);
  if (!checkMaxHandlers(info)) {
    return;
  }
  if (handlePreRegister(sock,address)) {
    final boolean debug=log.isDebugEnabled();
    Match match=checkMatches(false,address,message);
    if (match.doesMatch) {
      Handler<Message> handler=new Handler<Message>(){
        public void handle(        final Message msg){
          Match curMatch=checkMatches(false,address,msg.body());
          if (curMatch.doesMatch) {
            Set<String> sockAuths=info.sockAuths;
            if (curMatch.requiresAuth && sockAuths == null) {
              if (debug) {
                log.debug("Outbound message for address " + address + " rejected because auth is required and socket is not authed");
              }
            }
 else {
              checkAddAccceptedReplyAddress(msg.replyAddress());
              deliverMessage(sock,address,msg);
            }
          }
 else {
            if (debug) {
              log.debug("Outbound message for address " + address + " rejected because there is no inbound match");
            }
          }
        }
      }
;
      handlers.put(address,handler);
      eb.registerHandler(address,handler);
      handlePostRegister(sock,address);
      info.handlerCount++;
    }
 else {
      if (debug) {
        log.debug("Cannot register handler for address " + address + " because there is no inbound match");
      }
    }
  }
}
