{
  if (connected) {
    Buffer data=message.encodeToWire();
    metrics.messageWritten(message.address(),data.length());
    socket.write(data);
  }
 else {
synchronized (this) {
      if (connected) {
        Buffer data=message.encodeToWire();
        metrics.messageWritten(message.address(),data.length());
        socket.write(data);
      }
 else {
        pending.add(message);
      }
    }
  }
}
