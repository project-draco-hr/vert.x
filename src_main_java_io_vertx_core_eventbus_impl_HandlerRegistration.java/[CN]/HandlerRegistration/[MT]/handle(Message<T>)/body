{
  Handler<Message<T>> theHandler=null;
synchronized (this) {
    if (paused) {
      if (pending.size() < maxBufferedMessages) {
        pending.add(message);
      }
 else {
        if (discardHandler != null) {
          discardHandler.handle(message);
        }
 else {
          log.warn("Discarding message as more than " + maxBufferedMessages + " buffered in paused consumer");
        }
      }
    }
 else {
      checkNextTick();
      if (metrics.isEnabled()) {
        boolean local=true;
        if (message instanceof ClusteredMessage) {
          ClusteredMessage cmsg=(ClusteredMessage)message;
          if (cmsg.isFromWire()) {
            local=false;
          }
        }
        metrics.beginHandleMessage(metric,local);
      }
      theHandler=handler;
    }
  }
  if (theHandler != null) {
    String creditsAddress=message.headers().get(MessageProducerImpl.CREDIT_ADDRESS_HEADER_NAME);
    if (creditsAddress != null) {
      eventBus.send(creditsAddress,1);
    }
    handleMessage(theHandler,message);
  }
}
